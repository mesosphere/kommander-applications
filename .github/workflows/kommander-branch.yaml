name: "Create Kommander Branch"

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  update-images-cve:
    name: Update Container Images for CVE Fixes
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.MESOSPHERECI_USER_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release skopeo

      - name: Install Trivy
        run: |
          # Install Trivy using the official installation script
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Verify installations
        run: |
          echo "Verifying required binaries are installed..."
          trivy --version
          skopeo --version
          python3 --version

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Run CVE update script
        id: update
        run: |
          python3 hack/test.py
          # Check if licenses.d2iq.yaml was modified
          if git diff --quiet licenses.d2iq.yaml; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected in licenses.d2iq.yaml"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected in licenses.d2iq.yaml"
            git diff licenses.d2iq.yaml
          fi

      - name: Configure Git And Branch
        id: genbranch
        if: steps.update.outputs.changes == 'true'
        run: |
          # Use the branch that triggered the workflow as the base.
          # This branch is expected to be rebased on main.
          git config user.name d2iq-mergebot
          git config user.email ci-mergebot@d2iq.com
          BRANCH="autobump_cve_$(date +%Y%m%d_%H%M%S)"
          echo "branch_name=$BRANCH" >> "$GITHUB_OUTPUT"


      # - name: Create branch and commit changes
      #   if: steps.update.outputs.changes == 'true'
      #   id: commit
      #   run: |
      #     BRANCH_NAME="autobump_cve_$(date +%Y%m%d_%H%M%S)"
      #     echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
      #     git checkout -b "$BRANCH_NAME"
      #     git add licenses.d2iq.yaml
      #     git commit -S -m "Update container images to fix CVEs"

      # - name: Push changes
      #   if: steps.update.outputs.changes == 'true'
      #   run: |
      #     git push origin "${{ steps.commit.outputs.branch_name }}"

      - name: Create Pull Request
        if: steps.update.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MESOSPHERECI_USER_TOKEN }}
          author: "d2iq-mergebot <ci-mergebot@d2iq.com>"
          committer: "d2iq-mergebot <ci-mergebot@d2iq.com>"
          base: main
          branch: ${{ steps.genbranch.outputs.branch_name }}
          add-paths: licenses.d2iq.yaml
          commit-message: "Update container images to fix CVEs"
          signoff: false
          title: "Auto Update Container Images to fix CVEs"
          body: "Automated weekly CVE update"
          labels: "automation,security"

      - name: Summary
        if: steps.update.outputs.changes != 'true'
        run: |
          echo "No CVE updates needed. All images are up-to-date or no fixes available."
