apiVersion: v1
kind: ConfigMap
metadata:
  name: centralized-opencost-config-defaults
  namespace: ${releaseNamespace}
data:
  values.yaml: |-
    priorityClassName: dkp-high-priority
    service:
      enabled: true
      labels:
        prometheus.kommander.d2iq.io/select: "true"
        servicemonitor.kommander.mesosphere.io/path: "metrics"
        servicemonitor.kommander.mesosphere.io/port: "http"
    opencost:
      selectorLabels:
        servicemonitor.kommander.mesosphere.io/path: "metrics"
      prometheus:
        internal:
          enabled: true
          namespaceName: ${releaseNamespace}
          serviceName: thanos-query
          port: 10902
      dataRetention:
        dailyResolutionDays: 14

      ui:
        enabled: false

      # backend
      exporter:
        image:
          registry: ghcr.io
          repository: opencost/opencost
          # to avoid upstream default tag that comes with a SHA
          tag: "1.119.2"
        cloudProviderApiKey: "to-be-replaced-by-a-valid-api-key-in-google-cloud"
        extraEnv:
          PROM_CLUSTER_ID_LABEL: "cluster"
          CURRENT_CLUSTER_ID_FILTER_ENABLED: "false"
        extraVolumeMounts:
        # Mount /var/configs as writable volume
        - name: config-volume
          mountPath: /var/configs
          readOnly: false
        apiIngress:
          enabled: false
        replicas: 1
        resources:
          requests:
            cpu: "10m"
            memory: "55Mi"
          limits:
            memory: "1Gi"
        persistence:
          enabled: true
          accessMode: ReadWriteOnce
          size: 10Gi

      metrics:
        kubeStateMetrics:
          emitKsmV1Metrics: false
          emitKsmV1MetricsOnly: false
        serviceMonitor:
          enabled: true
          additionalLabels:
            prometheus.kommander.d2iq.io/select: "true"
    extraVolumes:
      # Add writable volume at root level
      - name: config-volume
        emptyDir: {}
