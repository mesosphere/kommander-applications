apiVersion: v1
kind: ServiceAccount
metadata:
  name: istio-helm-pre-install
  namespace: ${releaseNamespace}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: istio-helm-pre-install-role
  namespace: ${releaseNamespace}
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: istio-helm-pre-install-rolebinding
  namespace: ${releaseNamespace}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: istio-helm-pre-install-role
subjects:
  - kind: ServiceAccount
    name: istio-helm-pre-install
    namespace: ${releaseNamespace}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: istio-helm-pre-install
  namespace: ${releaseNamespace}
spec:
  template:
    metadata:
      name: istio-helm-pre-install
    spec:
      serviceAccountName: istio-helm-pre-install
      restartPolicy: OnFailure
      priorityClassName: dkp-critical-priority
      containers:
        - name: check-old-istio
          image: "${kubetoolsImageRepository:=mesosphere/kubectl}:${kubetoolsImageTag:=v1.35.0-alpine}"
          command:
            - bash
            - -c
            - |
              set -o nounset
              set -o pipefail

              echo() {
                command echo $(date) "$@"
              }

              CHECK_INTERVAL=60

              echo "Istio-Helm Pre-Installation Check"

              # Loop until condition is met or timeout
              while true; do

                echo "Checking if ambient mode (ztunnel) is being enabled..."
                ZTUNNEL_ENABLED=$(kubectl get configmap istio-helm-config-overrides -n ${releaseNamespace} -o jsonpath='{.data.values\.yaml}' 2>/dev/null | grep -A 1 "^ztunnel:" | grep "enabled:" | awk '{print $2}' || command echo "false")
                echo "ztunnel.enabled = $ZTUNNEL_ENABLED"

                if [ "$ZTUNNEL_ENABLED" != "true" ]; then
                  echo ""
                  echo "Ambient mode is not enabled."
                  echo "istio-helm can coexist with legacy Istio installation."
                  echo "Skipping legacy Istio conflict check."
                  exit 0
                fi

                echo "Ambient mode (ztunnel) is enabled."
                echo "Checking for conflicting Istio Operator installation..."

                if kubectl get helmrelease istio -n ${releaseNamespace} >/dev/null 2>&1; then
                  echo ""
                  echo "Legacy Istio deployment is still present!"
                  echo "Ambient mode (ztunnel) cannot coexist with Istio Operator installation due to CNI and network policy conflicts."
                  echo ""
                  echo "ACTION REQUIRED:"
                  echo "Option 1: Disable ambient mode in istio-helm configuration, refer UI for disabling steps."
                  echo "Option 2: Migrate from Istio Operator to Istio Helm & then enable ambient mode after removing all istio operator resources."
                  echo ""
                  echo "For migration guidance, refer to NKP 2.17 Release Notes."
                  echo ""
                  echo "Waiting $CHECK_INTERVAL seconds before checking again..."

                  sleep $CHECK_INTERVAL
                  continue
                fi

                echo ""
                echo "No legacy Istio installation found."
                echo "Cluster is ready for istio-helm with ambient mode."
                exit 0
              done
