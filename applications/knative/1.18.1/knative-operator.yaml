---
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: knative-operator
  namespace: ${releaseNamespace}
spec:
  interval: 1m
  url: "oci://ghcr.io/mesosphere/charts/knative-operator"
  ref:
    tag: 1.18.1
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: knative-operator
  namespace: ${releaseNamespace}
spec:
  dependsOn:
    - name: istio
      namespace: ${releaseNamespace}
  chartRef:
    kind: OCIRepository
    name: knative-operator
    namespace: ${releaseNamespace}
  interval: 15s
  install:
    crds: CreateReplace
    remediation:
      retries: 30
    createNamespace: true
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 30
  releaseName: knative
  targetNamespace: knative-operator
  valuesFrom:
    - kind: ConfigMap
      name: knative-1.18.1-config-defaults
    - kind: ConfigMap
      name: knative-config-overrides
      optional: true
    - kind: ConfigMap
      name: knative-overrides
      optional: true
  # See https://jira.nutanix.com/browse/NCN-108562
  # We should remove these patches once a fix is merged upstream
  # Replace `{{ .Chart.Version }}` values found here: https://github.com/knative/operator/blob/knative-v1.18.1/config/charts/knative-operator/templates/operator.yaml in file order
  # We're using JSON6902 style patching: https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/patches/#patch-using-path-json6902
  # this means `~1` is used to lookup `app.kubernetes.io/version` as `app.kubernetes.io~1version`
  # example here: https://fluxcd.io/flux/components/helm/helmreleases/#ignore-annotation
  postRenderers:
    - kustomize:
        patches:
          - target:
              version: v1
              kind: Secret
              name: operator-webhook-certs
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: apps/v1
              kind: Deployment
              name: operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: apps/v1
              kind: Deployment
              name: operator-webhook
            patch: |
              - op: replace
                path: /spec/template/metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: v1
              kind: Service
              name: operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: apiextensions.k8s.io/v1
              kind: CustomResourceDefinition
              name: knativeeventings.operator.knative.dev
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: apiextensions.k8s.io/v1
              kind: CustomResourceDefinition
              name: knativeservings.operator.knative.dev
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-serving-operator-aggregated
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-serving-operator-aggregated-stable
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-eventing-operator-aggregated
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-eventing-operator-aggregated-stable
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-serving-operator
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-eventing-operator
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: v1
              kind: ServiceAccount
              name: knative-operator
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: knative-serving-operator
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: knative-eventing-operator
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: Role
              name: knative-operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRole
              name: knative-operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: v1
              kind: ServiceAccount
              name: operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: RoleBinding
              name: operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: operator-webhook
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: knative-serving-operator-aggregated
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: knative-serving-operator-aggregated-stable
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: knative-eventing-operator-aggregated
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: rbac.authorization.k8s.io/v1
              kind: ClusterRoleBinding
              name: knative-eventing-operator-aggregated-stable
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: v1
              kind: ConfigMap
              name: config-logging
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: v1
              kind: ConfigMap
              name: config-observability
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: apps/v1
              kind: Deployment
              name: knative-operator
            patch: |
              - op: replace
                path: /metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
          - target:
              version: apps/v1
              kind: Deployment
              name: knative-operator
            patch: |
              - op: replace
                path: /spec/template/metadata/labels/app.kubernetes.io~1version
                value: 1.18.1
