apiVersion: logging.banzaicloud.io/v1beta1
kind: FluentbitAgent
metadata:
  name: logging-operator  # must match your Logging resource name
  namespace: ${releaseNamespace}
spec:
  podPriorityClassName: dkp-critical-priority
  image:
    repository: ghcr.io/mesosphere/dkp-container-images/docker.io/fluent/fluent-bit
    tag: 4.0.3-d2iq.0
  resources:
    limits:
      memory: 750Mi
    requests:
      cpu: 350m
      memory: 350Mi
  tolerations:
    - operator: Exists
      effect: NoSchedule
    - operator: Exists
      effect: NoExecute
    - operator: Exists
      key: CriticalAddonsOnly
  flush: 1
  grace: 5
  logLevel: warn
  coroStackSize: 24576
  inputTail:
    Path: /var/log/containers/*.log
    Tag: kubernetes.*
    Parser: cri
    DB: /tail-db/kubernetes.db
    Skip_Long_Lines: "On"
    Refresh_Interval: "5"
    Rotate_Wait: "5"
    Mem_Buf_Limit: 5MB
  filterKubernetes:
    Match: kubernetes.*
    Kube_Tag_Prefix: kubernetes.var.log.containers
    Merge_Log: "On"
    Labels: "On"
    Annotations: "On"
    Buffer_Size: "0"
    Kube_URL: https://kubernetes.default.svc:443
    Kube_CA_File: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File: /var/run/secrets/kubernetes.io/serviceaccount/token
    tls.verify: "On"
    K8S-Logging.Parser: "Off"
    K8S-Logging.Exclude: "Off"
  forwardOptions:
    Retry_Limit: "5"
  positiondb:
    hostPath:
      path: /var/log/tail-db
      type: DirectoryOrCreate
  metrics:
    port: 2020
    path: /api/v1/metrics/prometheus
    prometheusAnnotations: true
  daemonsetAnnotations:
    secret.reloader.stakater.com/reload: logging-operator-logging-fluentbit-tls
