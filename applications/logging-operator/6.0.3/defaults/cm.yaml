apiVersion: v1
kind: ConfigMap
metadata:
  name: logging-operator-6.0.3-config-defaults
  namespace: ${releaseNamespace}
data:
  values.yaml: |
    ---
    fluentbit:
      enabled: false

    # Define input source for Fluentd (acts as log receiver)
    clusterInputs:
      - name: fluentd-forward
        spec:
          forward:
            bind: "0.0.0.0"
            port: 24224

    # Define the flow: input -> output
    clusterFlows:
      - name: cluster-containers
        spec:
          inputRefs:
            - fluentd-forward
          globalOutputRefs:
            - loki

    # Define output: Loki
    clusterOutputs:
      - name: loki
        spec:
          loki:
            url: http://grafana-loki-loki-distributed-gateway.${releaseNamespace}.svc.cluster.local:80
            extract_kubernetes_labels: true
            configure_kubernetes_labels: true
            buffer:
              retry_forever: false
              retry_max_times: 5
              flush_mode: interval
              flush_interval: 10s
              flush_thread_count: 8
            extra_labels:
              log_source: kubernetes_container

    # TLS for fluentd endpoints
    tls:
      enabled: true

    # Fluentd configuration
    fluentd:
      podPriorityClassName: "dkp-critical-priority"
      image:
        repository: ghcr.io/kube-logging/logging-operator/fluentd
        tag: 6.0.3-full
      resources:
        limits:
          memory: 400Mi
          cpu: 1000m
        requests:
          memory: 100Mi
          cpu: 500m
      scaling:
        replicas: 1
      port: 24240
      readinessProbe:
        failureThreshold: 3
        initialDelaySeconds: 5
        periodSeconds: 5
        successThreshold: 1
        tcpSocket:
          port: 24240
        timeoutSeconds: 3
      logLevel: warn
      fluentLogDestination: stdout

      # Persistent buffer
      bufferStorageVolume:
        pvc:
          source:
            claimName: fluentd-buffer
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 10Gi
            volumeMode: Filesystem

      # Metrics
      metrics:
        port: 24231
        path: /metrics
        prometheusAnnotations: true
      bufferVolumeMetrics:
        port: 9200
        path: /metrics
        prometheusAnnotations: true

      # Config-reloader integration
      statefulsetAnnotations:
        secret.reloader.stakater.com/reload: logging-operator-logging-fluentd-tls
