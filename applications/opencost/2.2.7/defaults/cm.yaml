apiVersion: v1
kind: ConfigMap
metadata:
  name: opencost-2.2.7-config-defaults
  namespace: ${releaseNamespace}
data:
  values.yaml: |-
    priorityClassName: dkp-high-priority
    service:
      enabled: true
      labels:
        prometheus.kommander.d2iq.io/select: "true"
        servicemonitor.kommander.mesosphere.io/path: "metrics"
        servicemonitor.kommander.mesosphere.io/port: "http"
    opencost:
      selectorLabels:
        servicemonitor.kommander.mesosphere.io/path: "metrics"
      prometheus:
        internal:
          enabled: true
          namespaceName: ${releaseNamespace}
          serviceName: kube-prometheus-stack-prometheus
          port: 9090

      dataRetention:
        dailyResolutionDays: 14

      # frontend
      ui:
        image:
          registry: ghcr.io
          repository: opencost/opencost-ui
          tag: "1.117.3"
        enabled: true
        ingress:
          enabled: true
          ingressClassName: "kommander-traefik"
          annotations:
            traefik.ingress.kubernetes.io/router.tls: "true"
            traefik.ingress.kubernetes.io/router.middlewares: "${workspaceNamespace}-stripprefixes@kubernetescrd,${workspaceNamespace}-forwardauth@kubernetescrd"
          hosts:
            - host: ""
              paths:
                - /dkp/opencost/frontend

      # backend
      exporter:
        image:
          registry: ghcr.io
          repository: opencost/opencost
          tag: "1.117.3"
        extraEnv:
          CURRENT_CLUSTER_ID_FILTER_ENABLED: "false"
          CURRENT_CLUSTER_ID_FILTER_ENABLED: "false"
        apiIngress:
          enabled: false

        replicas: 1
        resources:
          requests:
            cpu: "10m"
            memory: "55Mi"
          limits:
            memory: "1Gi"
        persistence:
          enabled: true
          storageClass: "nutanix-volume"
          accessMode: ReadWriteOnce
          size: 10Gi

      metrics:
        kubeStateMetrics:
          emitKsmV1Metrics: false
          emitKsmV1MetricsOnly: false
        serviceMonitor:
          enabled: true
          additionalLabels:
            prometheus.kommander.d2iq.io/select: "true"
          additionalLabels:
            prometheus.kommander.d2iq.io/select: "true"
