---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dex-2.9.10-d2iq-defaults
  namespace: ${releaseNamespace}
data:
  values.yaml: |-
    ---
    image: mesosphere/dex
    imageTag: v2.27.0-4-g8c72a-d2iq
    resources:
      requests:
        cpu: 100m
        memory: 50Mi
    deploymentAnnotations:
      secret.reloader.stakater.com/reload: kommander-traefik-certificate,${dkpCredentialsSecret:=dkp-credentials}
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: kommander-traefik
        ingress.kubernetes.io/protocol: https
        traefik.ingress.kubernetes.io/router.tls: "true"
      path: /dex
      hosts:
        - ''
    https: true
    ports:
      web:
        containerPort: 8080
    certs:
      web:
        create: false
        secret:
          tlsName: dex
    config:
      issuer: https://dex.${releaseNamespace}.svc.cluster.local:8080/dex
      frontend:
        issuer: Kubernetes
        theme: d2iq
      storage:
        type: kubernetes
        config:
          inCluster: true
      logger:
        level: debug
      web:
        address: 0.0.0.0
        tlsCert: /etc/dex/tls/https/server/tls.crt
        tlsKey: /etc/dex/tls/https/server/tls.key
      grpc:
        address: 0.0.0.0
        tlsCert: /etc/dex/tls/grpc/server/tls.crt
        tlsKey: /etc/dex/tls/grpc/server/tls.key
        tlsClientCA: /etc/dex/tls/grpc/ca/tls.crt
      oauth2:
        skipApprovalScreen: true
      staticClients:
        - id: kube-apiserver
          name: Kubernetes CLI authenticator
          redirectURIs:
            - https://PUBLIC.URI/token/callback/kubernetes-cluster
            - https://PUBLIC.URI/token/callback
            - https://PUBLIC.URI/token/async/callback
        - id: traefik-forward-auth
          name: DKP authenticator
          redirectURIs:
            - https://PUBLIC.URI/_oauth
    initContainers:
      - name: initialize-dex
        image: ${initializerImage:=mesosphere/kubeaddons-addon-initializer:v0.5.5}
        args:
          - dex
        env:
          - name: DEX_NAMESPACE
            value: ${releaseNamespace}
          - name: DEX_SECRET_NAME
            value: dex
          - name: OPS_PORTAL_NAMESPACE
            value: ${releaseNamespace}
          - name: OPS_PORTAL_SECRET_NAME
            value: ${dkpCredentialsSecret:=dkp-credentials}
          - name: TRAEFIK_NAMESPACE
            value: ${releaseNamespace}
          - name: TRAEFIK_SERVICE_NAME
            value: kommander-traefik
    certIssuerRef:
      kind: ${certificateIssuerKind:=Issuer}
      name: ${certificateIssuerName}
    env:
      - name: KUBERNETES_POD_NAMESPACE
        valueFrom:
          fieldRef:
            fieldPath: metadata.namespace
    dex-controller:
      controller:
        manager:
          dexConfigSecretName: dex
          dexDeploymentName: dex
    service:
      metrics:
        labels:
          servicemonitor.kommander.mesosphere.io/path: metrics
