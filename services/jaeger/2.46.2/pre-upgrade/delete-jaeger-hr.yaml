# For upgrades from DKP <2.6 to 2.6.x.
# **REMOVE THIS AFTER 2.6 IS RELEASED**
# Delete the jaeger helmrelease prior to upgrading.
# This must be done because upgrading does not apply the newly added priorityClassName field on the
# Jaeger spec, perhaps because the CRD has not been upgraded yet. Recreating the HelmRelease applies the
# Jaeger spec properly. This job will only delete helmreleases from 2.5, so rerunning this job
# during upgrades within 2.6 will not result in the recreation of the helmrelease.
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jaeger-pre-upgrade
  namespace: ${releaseNamespace}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: jaeger-pre-upgrade
  namespace: ${releaseNamespace}
rules:
  - apiGroups: ["helm.toolkit.fluxcd.io"]
    resources: ["helmreleases"]
    verbs: ["get", "watch", "list", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: jaeger-pre-upgrade
  namespace: ${releaseNamespace}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: jaeger-pre-upgrade
subjects:
  - kind: ServiceAccount
    name: jaeger-pre-upgrade
    namespace: ${releaseNamespace}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: delete-jaeger-helmrelease
  namespace: ${releaseNamespace}
spec:
  ttlSecondsAfterFinished: 100
  template:
    metadata:
      name: delete-jaeger-helmrelease
    spec:
      serviceAccountName: jaeger-pre-upgrade
      restartPolicy: OnFailure
      priorityClassName: dkp-high-priority
      containers:
        - name: kubectl
          image: bitnami/kubectl:1.26.4
          command:
            - sh
            - "-c"
            - |-
              /bin/bash <<'EOF'
              set -o nounset
              set -o errexit
              set -o pipefail

              echo "checking jaeger helmrelease and deleting it pre-upgrade if older than v2.46.2"

              VERSION=$(set -o errexit; kubectl get helmrelease -n ${releaseNamespace} jaeger --ignore-not-found -o=jsonpath='{.spec.chart.spec.version}')
              echo "pre-upgrade jaeger version $VERSION"
              if [[ $VERSION < "2.46.2" ]]; then
                echo "deleting jaeger helmrelease"
                kubectl delete helmrelease jaeger -n ${releaseNamespace} --ignore-not-found
                exit 0
              fi
              EOF
