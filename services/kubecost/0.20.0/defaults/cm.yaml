---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kubecost-0.20.0-d2iq-defaults
  namespace: ${releaseNamespace}
data:
  values.yaml: |
    ---
    cost-analyzer:
      global:
        prometheus:
          enabled: true
        grafana:
          enabled: true

      ingress:
        enabled: true
        # We can remove this once https://github.com/kubecost/cost-analyzer-helm-chart/pull/1132 is released.
        className: ""
        annotations:
          kubernetes.io/ingress.class: kommander-traefik
          ingress.kubernetes.io/auth-response-headers: X-Forwarded-User
          traefik.ingress.kubernetes.io/router.tls: "true"
          traefik.ingress.kubernetes.io/router.middlewares: "${workspaceNamespace}-stripprefixes@kubernetescrd,${workspaceNamespace}-forwardauth@kubernetescrd"
        paths:
          - "/dkp/kubecost/frontend/"
        hosts:
          - ""
        tls: []

      podSecurityPolicy:
        enabled: false

      grafana:
        image:
          # Overriding version to pull in a fix for a CVE.
          # See <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-43798>.
          # Can remove once image bump done in below PR is released.
          # https://github.com/kubecost/cost-analyzer-helm-chart/pull/1171
          tag: 8.3.2
        ingress:
          enabled: true
          annotations:
            kubernetes.io/ingress.class: kommander-traefik
            ingress.kubernetes.io/auth-response-headers: X-Forwarded-User
            traefik.ingress.kubernetes.io/router.tls: "true"
            traefik.ingress.kubernetes.io/router.middlewares: "${workspaceNamespace}-stripprefixes@kubernetescrd,${workspaceNamespace}-forwardauth@kubernetescrd"
          hosts: [""]
          path: "/dkp/kubecost/grafana"
        grafana.ini:
          server:
            protocol: http
            enable_gzip: true
            root_url: "%(protocol)s://%(domain)s:%(http_port)s/dkp/kubecost/grafana"
          auth.proxy:
            enabled: true
            header_name: X-Forwarded-User
            auto-sign-up: true
          auth.basic:
            enabled: false
          users:
            auto_assign_org_role: Admin

      kubecostProductConfigs:
        grafanaURL: "/dkp/kubecost/grafana"
        # used for display in Kubecost UI
        clusterName: "Kommander Managed Cluster"
