apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: kubecost
  namespace: ${releaseNamespace}
spec:
  chart:
    spec:
      chart: cost-analyzer
      sourceRef:
        kind: HelmRepository
        name: kubecost
        namespace: kommander-flux
      version: 2.5.0
  interval: 15s
  install:
    crds: CreateReplace
    remediation:
      retries: 30
    createNamespace: true
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 30
  releaseName: kubecost
  valuesFrom: # The order is important. The last entry will override the previous ones.
    - kind: ConfigMap
      name: kubecost-2.5.0-d2iq-defaults # Configures the kubecost cluster as secondary.
    - kind: ConfigMap
      name: kubecost-2.5.0-d2iq-defaults
      valuesKey: ${releaseNamespace}-namespace-values.yaml # Configures the kubecost cluster as primary.
      optional: true
    - kind: ConfigMap
      name: kubecost-2.5.0-d2iq-defaults
      valuesKey: ${releaseNamespace}-namespace-${kubecostClusterMode}-values.yaml # Configures the primary kubecost cluster with multi-cluster mode.
      optional: true
  targetNamespace: ${releaseNamespace}
  postRenderers:
    - kustomize:
        patches:
          # The name of grafana datasource configmap is hardcoded in upstream chart. Use postRenderers to make the name specific to kubecost (no-op on attached clusters).
          - target:
              version: v1
              kind: ConfigMap
              name: grafana-datasource
            patch: |
              - op: replace
                path: /metadata/name
                value: kubecost-grafana-datasource
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dkp-kubecost-view
rules:
  - nonResourceURLs:
      - /dkp/kommander/kubecost
      - /dkp/kommander/kubecost/*
    verbs:
      - get
      - head
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dkp-kubecost-edit
rules:
  - nonResourceURLs:
      - /dkp/kommander/kubecost
      - /dkp/kommander/kubecost/*
    verbs:
      - get
      - head
      - post
      - put
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dkp-kubecost-admin
rules:
  - nonResourceURLs:
      - /dkp/kommander/kubecost
      - /dkp/kommander/kubecost/*
    verbs:
      - get
      - head
      - post
      - put
      - delete
---
