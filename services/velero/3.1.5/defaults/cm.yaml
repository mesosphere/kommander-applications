
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: velero-3.1.5-d2iq-defaults
  namespace: ${releaseNamespace}
data:
  values.yaml: |
    ---
    enableHelmHooks: false # handle helm install --atomic through kubeaddons
    configuration:
      provider: "aws"
      backupStorageLocation:
        bucket: "velero"
        config:
          region: "fallback" # enables non-production fallback minio backend, detected by kubeaddons-addon-initializer
          s3Url: http://minio.velero.svc:9000 # this default value is overwritten by kubeaddons-addon-initializer unless set to something different
          s3ForcePathStyle: true
          insecureSkipTLSVerify: "true"
      volumeSnapshotLocation:
        config:
          region: "fallback"
    credentials:
      name: velero-d2iq-credentials
      secretContents:
        cloud: "placeholder"
    schedules:
      default:
        schedule: "0 0 * * *"
        template:
          ttl: 720h # 30 day retention, required to create schedule
    metrics:
      enabled: true
      service:
        labels:
          servicemonitor.kommander.mesosphere.io/path: "metrics"
    initContainers:
      - name: initialize-velero
        image: "${initializerImage:=mesosphere/kubeaddons-addon-initializer:v0.5.5}"
        args: ["velero"]
        env:
          - name: "MINIO_INGRESS_NAMESPACE"
            value: ${releaseNamespace}
          - name: "MINIO_INGRESS_SERVICE_NAME"
            value: kommander-traefik
          - name: "VELERO_NAMESPACE"
            value: ${releaseNamespace}
          - name: "VELERO_MINIO_FALLBACK_SECRET_NAME"
            value: "velero-d2iq-credentials"
      - name: velero-plugin-for-aws
        image: velero/velero-plugin-for-aws:v1.1.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
    minioBackend: true
    minio:
      mode: distributed
      defaultBucket:
        enabled: true
        name: velero
      bucketRoot: "/data"
      mountPath: "/data"
      existingSecret: minio-creds-secret # generated by mesosphere/kubeaddons-addon-initializer
      resources:
        requests:
          memory: 256Mi
          cpu: 250m
        limits:
          memory: 512Mi
          cpu: 750m
      persistence:
        size: 10Gi # match default of old minio version
      ingress:
        enabled: true
        hosts:
          - ""
        annotations:
          kubernetes.io/ingress.class: kommander-traefik
          traefik.ingress.kubernetes.io/router.entrypoints: velero-minio # see "ports" in the Traefik chart values
          # Required by migration from k1x to k20, can be removed once we no longer
          # support migrating from k1x
          traefik.ingress.kubernetes.io/router.priority: "10"
