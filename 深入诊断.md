# Image Reflector Controller PriorityClassName 问题深入诊断

## 问题确认
- Deployment 的 spec 中**没有** priorityClassName
- HelmRelease 已经成功升级
- image-automation-controller 可以工作，但 image-reflector-controller 不行

## 可能的原因

### 1. Helm Values 合并问题
检查 ConfigMap 是否正确：
```bash
kubectl get configmap kommander-flux-overrides -n kommander -o yaml
```

### 2. Flux Chart 版本问题
当前使用的是 `flux2@2.17.1`，可能需要检查这个版本是否支持 imageReflectorController 的 priorityClassName。

### 3. 字段名称或结构问题
可能 Flux chart 对这两个控制器的处理方式不同。

## 诊断步骤

### 步骤 1: 验证 ConfigMap 内容
```bash
kubectl get configmap kommander-flux-overrides -n kommander -o yaml | grep -A 20 imageReflectorController
```

确保 YAML 格式正确，特别是：
- 缩进正确（2个空格）
- 没有隐藏字符
- 字段名称完全匹配：`imageReflectorController`（注意大小写）

### 步骤 2: 检查 Helm Release 的实际 Values
```bash
# 找到 Helm secret
SECRET_NAME=$(kubectl get secret -n kommander -l owner=helm,name=kommander-flux -o jsonpath='{.items[0].metadata.name}')

# 查看 values（需要 helm 工具）
kubectl get secret "$SECRET_NAME" -n kommander -o jsonpath='{.data.release}' | base64 -d | gunzip | helm template --show-only /dev/stdin 2>/dev/null || echo "需要 helm 工具"
```

### 步骤 3: 强制 HelmRelease 重新协调
```bash
kubectl annotate helmrelease kommander-flux -n kommander reconcile.fluxcd.io/requestedAt="$(date +%s)" --overwrite
```

等待几分钟后检查 Deployment。

## 临时解决方案

如果 Helm values 无法正确应用，可以手动修补 Deployment：

```bash
kubectl patch deployment image-reflector-controller -n kommander-flux -p '{"spec":{"template":{"spec":{"priorityClassName":"system-cluster-critical"}}}}'
```

然后删除 Pod 让 Deployment 重新创建：
```bash
kubectl delete pod -n kommander-flux -l app=image-reflector-controller
```

## 根本解决方案

如果问题持续存在，可能需要：
1. 检查 Flux chart 的模板，确认 imageReflectorController 是否正确使用 values
2. 考虑升级或降级 Flux chart 版本
3. 使用 postRenderers 在 HelmRelease 中直接修补 Deployment
