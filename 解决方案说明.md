# Flux Image Controllers 优先级类问题解决方案

## 问题描述

在 `kommander-flux-overrides` ConfigMap 中为 `imageReflectorController` 设置 `priorityClassName` 时，优先级类没有应用到 Pod 上，而 `imageAutomationController` 却可以正常工作。

## 根本原因

当 Helm 从多个 `valuesFrom` 源合并值时，部分覆盖嵌套对象有时会合并失败。默认配置包含：
```yaml
imageReflectorController:
  resources: {...}
  priorityClassName: system-cluster-critical
  podSecurityContext: {...}
```

如果只覆盖：
```yaml
imageReflectorController:
  priorityClassName: system-cluster-critical
```

Helm 的合并逻辑可能无法正确应用覆盖值，导致 `imageReflectorController` 的优先级类丢失。

## 解决方案

**关键点：** 在覆盖配置时，需要包含所有字段（`resources`、`priorityClassName` 和 `podSecurityContext`），以确保 Helm 能够正确合并嵌套对象。

### 正确的 ConfigMap 结构

我已经创建了修复后的配置文件 `kommander-flux-overrides-fix.yaml`，其中包含了所有必需的字段：

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kommander-flux-overrides
  namespace: kommander
data:
  values.yaml: |
    # ... 其他控制器的配置 ...
    imageAutomationController:
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 64Mi
      priorityClassName: system-cluster-critical
      podSecurityContext:
        fsGroup: 1337
    imageReflectorController:
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 100m
          memory: 64Mi
      priorityClassName: system-cluster-critical
      podSecurityContext:
        fsGroup: 1337
```

## 应用修复

1. **应用修复后的 ConfigMap：**
   ```bash
   kubectl apply -f kommander-flux-overrides-fix.yaml
   ```

2. **等待 HelmRelease 协调：**
   ```bash
   kubectl get helmrelease kommander-flux -n kommander-flux -w
   ```

3. **验证修复：**
   ```bash
   kubectl get pods -n kommander-flux -o custom-columns=NAME:.metadata.name,PRIORITY:.spec.priorityClassName | grep image
   ```

   两个控制器现在都应该显示 `system-cluster-critical` 作为优先级类。

## 为什么会出现这个问题？

Helm 的深度合并机制在处理部分覆盖嵌套对象时可能会失败。当您只提供 `priorityClassName` 而不包含其他字段（如 `resources` 和 `podSecurityContext`）时，Helm 可能无法正确合并这些值，导致某些字段丢失。

通过包含所有字段，我们确保 Helm 能够正确合并整个嵌套对象，从而保证 `priorityClassName` 被正确应用。

## 技术细节

- Helm 使用深度合并策略来合并多个 `valuesFrom` 源
- 当覆盖嵌套对象时，如果只提供部分字段，合并可能不完整
- `imageAutomationController` 可能因为处理顺序或缓存的原因暂时工作，但这不是可靠的解决方案
- 包含所有字段是最可靠的方法，确保配置的一致性
