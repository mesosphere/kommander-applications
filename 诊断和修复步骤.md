# Image Reflector Controller 优先级类问题诊断和修复

## 问题现象
即使更新了 ConfigMap，`image-reflector-controller` Pod 仍然显示 `<none>` 作为优先级类。

## 可能的原因

1. **Pod 还没有重新创建** - Deployment 可能已经更新，但旧的 Pod 还在运行
2. **HelmRelease 还没有协调** - Flux 可能还没有应用新的配置
3. **Deployment 配置没有更新** - 需要检查 Deployment 的 spec 中是否包含 priorityClassName

## 诊断步骤

### 1. 检查 Deployment 配置
```bash
kubectl get deployment image-reflector-controller -n kommander-flux -o yaml | grep -A 10 priorityClassName
```

如果 Deployment 的 `spec.template.spec.priorityClassName` 已经设置为 `system-cluster-critical`，但 Pod 还没有更新，需要删除 Pod 强制重新创建。

### 2. 检查 HelmRelease 状态
```bash
kubectl get helmrelease kommander-flux -n kommander-flux
kubectl describe helmrelease kommander-flux -n kommander-flux
```

### 3. 检查 ConfigMap 是否正确应用
```bash
kubectl get configmap kommander-flux-overrides -n kommander -o yaml
```

## 修复步骤

### 方案 1: 强制重新创建 Pod（推荐）

如果 Deployment 已经更新但 Pod 还没有重新创建：

```bash
# 删除 Pod，让 Deployment 重新创建
kubectl delete pod -n kommander-flux -l app=image-reflector-controller

# 等待 Pod 重新创建后验证
kubectl get pods -n kommander-flux -o custom-columns=NAME:.metadata.name,PRIORITY:.spec.priorityClassName | grep image
```

### 方案 2: 强制 HelmRelease 重新协调

```bash
# 添加注释触发重新协调
kubectl annotate helmrelease kommander-flux -n kommander-flux reconcile.fluxcd.io/requestedAt="$(date +%s)" --overwrite

# 或者删除并重新应用 HelmRelease（谨慎使用）
# kubectl delete helmrelease kommander-flux -n kommander-flux
# 然后等待 Flux 重新创建
```

### 方案 3: 检查并修复 Deployment（如果 Deployment 没有更新）

如果 Deployment 的 spec 中没有 priorityClassName，可能需要：

1. 检查 HelmRelease 的 values 是否正确合并
2. 手动修补 Deployment（临时方案）：
```bash
kubectl patch deployment image-reflector-controller -n kommander-flux -p '{"spec":{"template":{"spec":{"priorityClassName":"system-cluster-critical"}}}}'
```

## 验证

执行以下命令确认修复：
```bash
kubectl get pods -n kommander-flux -o custom-columns=NAME:.metadata.name,PRIORITY:.spec.priorityClassName | grep image
```

两个控制器都应该显示 `system-cluster-critical`。
